{include file='views/back/form_padrao/header.html'}
{include file='public/fineuploader/templates/template.html'}
{include file='modulos/$modulo.modulo/view/form/clones/autor.html'}
{include file='modulos/$modulo.modulo/view/form/clones/orientador.html'}

<div class="row">
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-6">
        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title">Dados do Trabalho</h3>
            </div>
            <div class="panel-body">
                <div class="form-group col-xs-12 col-sm-12 col-md-12 col-lg-12">
                    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                        <div class="form-group col-xs-12 col-sm-12 col-md-12 col-lg-12">
                            <label>Titulo</label>
                            <input type="text" class="form-control" name="{$modulo.modulo}[trabalho][titulo]" value="{if isset($cadastro.titulo)}{$cadastro.titulo}{/if}">
                        </div>

                        <!-- <div class="form-group">
                            <label>Idioma</label>
                            <br>
                            <input id="idioma" name="{$modulo.modulo}[idioma]" style="width: 100%">
                        </div> -->

                        <div class="form-group col-xs-12 col-sm-12 col-md-12 col-lg-12">
                            <label>Ano</label>
                            <input id="data_limite" type="text" autocomplete="off" placeholder="Exemplo: 2018" maxlength="4" class="form-control somente_numeros"  name="{$modulo.modulo}[trabalho][ano]" value="{if isset($cadastro.ano)}{$cadastro.ano}{/if}">
                        </div>

                        <div class="form-group col-xs-12 col-sm-12 col-md-12 col-lg-12">
                            <label>Curso</label>
                            <br>
                            <input id="curso" name="{$modulo.modulo}[trabalho][id_curso]" style="width: 100%">
                        </div>

                        <div class="form-group col-xs-12 col-sm-12 col-md-12 col-lg-12">
                            <label>Campus</label>
                            <br>
                            <input id="campus" name="{$modulo.modulo}[trabalho][id_campus]" style="width: 100%">
                        </div>

                        <div class="form-group col-xs-12 col-sm-12 col-md-12 col-lg-12">
                            <label>Palavras Chave</label>
                            <br>
                            <input id="palavra_chave" name="{$modulo.modulo}[palavras_chave]" style="width: 100%">
                        </div>

                        <div class="form-group col-xs-12 col-sm-12 col-md-12 col-lg-12">
                            <label>Resumo</label>
                            <textarea class="form-control" rows="3" name="{$modulo.modulo}[trabalho][resumo]">{if isset($cadastro.resumo)}{$cadastro.resumo}{/if}</textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-6">
        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title">Arquivos</h3>
            </div>
            <div class="panel-body">
                <div class="form-group col-xs-12 col-sm-12 col-md-12 col-lg-12">
                    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                        <div class="form-group col-xs-12 col-sm-12 col-md-12 col-lg-12">
                            <div id="upload_trabalho_trigger" class="lazy_view_remove"></div>
                        </div>
                        <div class="form-group col-xs-12 col-sm-12 col-md-12 col-lg-12">
                            <div id="upload_trabalho" class="row">
                                {if isset($cadastro.trabalho_relaciona_arquivo.0.arquivo.0) && !empty($cadastro.trabalho_relaciona_arquivo.0.arquivo.0)}
                                    <div class="form-group col-xs-12 col-sm-12 col-md-12 col-lg-12">
                                       <div class="panel panel-default">
                                           <div class="panel-body">
                                                <a href="/{$cadastro.trabalho_relaciona_arquivo.0.arquivo.0.endereco}" target="_blank">
                                                    {if isset($cadastro.trabalho_relaciona_arquivo.0.thumb.0) && !empty($cadastro.trabalho_relaciona_arquivo.0.thumb.0)}
                                                        <img style="width: 100%;" src="/{$cadastro.trabalho_relaciona_arquivo.0.thumb.0.endereco}">
                                                        <input type="hidden" value="{$cadastro.trabalho_relaciona_arquivo.0.thumb.0.id}" name="trabalho[arquivo][0][id_arquivo_thumb]">
                                                    {else}
                                                        <p class="text-center" style="font-size: 150px"><i class="fa fa-file-pdf-o text-center"></i></p>
                                                    {/if}
                                                    <h3 class="text-center">{$cadastro.trabalho_relaciona_arquivo.0.arquivo.0.nome}  {$cadastro.trabalho_relaciona_arquivo.0.arquivo.0.extensao}</h3>
                                                    <input type="hidden" value="{$cadastro.trabalho_relaciona_arquivo.0.arquivo.0.id}" name="trabalho[arquivo][0][id_arquivo]">
                                                </a>
                                           </div>
                                       </div>
                                    </div>
                                {/if}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{if !empty($blame)}
<div class="module-wrapper col-lg-12 col-md-12 col-sm-12 col-xs-12">
    <section class="module module-has-footer module-tickets">
        <div class="module-inner">
            <div class="module-heading">
                <h3 class="module-title">Historico de Alterações</h3>
                <ul class="actions list-inline">
                    <li><a class="collapse-module" data-toggle="collapse" href="#content-tickets" aria-expanded="false" aria-controls="content-tickets"><span aria-hidden="true" class="icon arrow_carrot-up"></span></a></li>
                </ul>
            </div>

            <div class="module-content collapse in" id="content-tickets">
                <div class="module-content-inner">
                    <div class="table-responsive">
                        <table class="table table-simple">
                            <thead>
                                <tr>
                                    <th style="width: 10%;" class="number">Data</th>
                                    <th style="width: 30%;" class="truncate">Usuario</th>
                                    <th style="width: 5%;" >Operação</th>
                                </tr>
                            </thead>
                            <tbody>

                                {foreach from=$blame key=indice item=culpado}
                                    <tr>
                                        <td>{$culpado.data}</td>
                                        <td>
                                            <span class="truncate">
                                                {if !empty($culpado.usuario.0.pessoa)}
                                                    {$culpado.usuario.0.pessoa.0.nome} {$culpado.usuario.0.pessoa.0.sobrenome}
                                                {else}
                                                    {$culpado.usuario.0.email}
                                                {/if}
                                            </span>
                                        </td>
                                        <td><span class="{$culpado.cor_tag}">{$culpado.operacao}</span></td>
                                    </tr>
                                {/foreach}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>
{/if}


{literal}
<script type="text/javascript">
    $('#idioma').select2({
        placeholder: $(this).data('placeholder'),
        multiple: false,
        minimumInputLength: 2,
        ajax: {
            type: 'POST',
            url: "/idioma/buscar_idioma_select2",
            dataType: 'json',
            data: function(term) {
                return {
                    busca: {
                        nome: term,
                        page_limit: 10,
                        cadastrar_busca: true
                    }
                };
            },
            results: function(data) {
                return {
                    results: data
                };
            }
        },
        formatResult: function(object) {
            return object.idioma
        },
        formatSelection: function(object) {
            return object.idioma.replace_all('Cadastrar ', '')
        }
    });

    $('#palavra_chave').select2({
        placeholder: $(this).data('placeholder'),
        multiple: true,
        minimumInputLength: 2,
        ajax: {
            type: 'POST',
            url: "/palavra_chave/buscar_palavra_chave_select2",
            dataType: 'json',
            data: function(term) {
                return {
                    busca: {
                        nome: term,
                        page_limit: 10,
                        cadastrar_busca: true
                    }
                };
            },
            results: function(data) {
                return {
                    results: data
                };
            }
        },
        formatResult: function(object) {
            console.log(object);
            return object.palavra_chave
        },
        formatSelection: function(object) {
            return object.palavra_chave.replace_all('Cadastrar ', '')
        }
    });

    $('#curso').select2({
        placeholder: $(this).data('placeholder'),
        multiple: false,
        minimumInputLength: 2,
        ajax: {
            type: 'POST',
            url: "/curso/buscar_curso_select2",
            dataType: 'json',
            data: function(term) {
                return {
                    busca: {
                        nome: term,
                        page_limit: 10,
                        cadastrar_busca: true
                    }
                };
            },
            results: function(data) {
                return {
                    results: data
                };
            }
        },
        formatResult: function(object) {
            console.log(object);
            return object.curso
        },
        formatSelection: function(object) {
            return object.curso.replace_all('Cadastrar ', '')
        }
    });

    $('#campus').select2({
        placeholder: $(this).data('placeholder'),
        multiple: false,
        minimumInputLength: 2,
        ajax: {
            type: 'POST',
            url: "/campus/buscar_campus_select2",
            dataType: 'json',
            data: function(term) {
                return {
                    busca: {
                        nome: term,
                        page_limit: 10,
                        cadastrar_busca: true
                    }
                };
            },
            results: function(data) {
                return {
                    results: data
                };
            }
        },
        formatResult: function(object) {
            console.log(object);
            return object.campus
        },
        formatSelection: function(object) {
            return object.campus.replace_all('Cadastrar ', '')
        }
    });

    var trabalho_manualUploader = new qq.FineUploader({
        element: document.getElementById('upload_trabalho_trigger'),
        validation: {
            allowedExtensions: ["pdf"],
            sizeLimit: 50000000
        },
        template: 'qq-template-manual-trigger',
        request: {
            endpoint: "/ajax_upload/upload/true",
        },
        thumbnails: {
            placeholders: {
                waitingPath: '/public/fineuploader/placeholders/waiting-generic.png',
                notAvailablePath: '/public/fineuploader/placeholders/not_available-generic.png'
            }
        },
        uploadSuccess: {
            endpoint: '/s3/success'
        },
        autoUpload: true,
        debug: false,
        multiple: false,
        callbacks: {
            onSubmit: function (id, fileName) {
                var local = {
                    local: 'trabalhos'
                }

                this.setParams(local);
            },
            onComplete: function(id, name, retorno, maybeXhr) {
                console.log(retorno);

                $('#upload_trabalho').html('');

                var thumb = '<p class="text-center" style="font-size: 150px"><i class="fa fa-file-pdf-o text-center"></p>';
                var thumb_id_arquivo = '';

                if(typeof retorno.thumb !== 'undefined'){
                    thumb = '<img style="width: 100%;" src="/' + retorno.thumb.endereco + '">';
                    thumb_id_arquivo = '<input type="hidden" value="' + retorno.thumb.id_arquivo + '" name="trabalho[arquivo][' + $("#upload_trabalho > div").length + '][id_arquivo_thumb]" />';
                }

                input = '<div class="form-group col-xs-12 col-sm-12 col-md-12 col-lg-12">'
                    +       '<div class="panel panel-default">'
                    +           '<div class="panel-body">'
                    +               thumb
                    +               '<h3 class="text-center">' + retorno.nome + retorno.extensao + '</h3>'
                    +               '<input type="hidden" value="' + retorno['id'] + '" name="trabalho[arquivo][' + $("#upload_trabalho > div").length + '][id_arquivo]" />'
                    +               thumb_id_arquivo
                    +           '</div>'
                    +       '</div>'
                    + '</div>'
                    + '<div class="clearfix"></div>';

                 console.log(input);

                 $('#upload_trabalho').append(input);
            }
        }
    });

    qq($('#upload_trabalho_trigger #trigger-upload').on('click', function(){
        trabalho_manualUploader.uploadStoredFiles();
    }));

    $('#data_limite').datetimepicker({
        sideBySide: true,
        debug: false,
        format: 'YYYY',
        maxDate: '2018-12-31',
        widgetPositioning: {
            horizontal: 'auto',
            vertical: 'bottom'
        }
    });






{/literal}
    {if isset($cadastro.curso.0.curso) && !empty($cadastro.curso.0.curso)}
{literal}
    $('#curso').select2(
        'data', {
            id: {/literal}{$cadastro.curso.0.id}{literal},
            curso: '{/literal}{$cadastro.curso.0.curso}{literal}'
        }
    );
{/literal}
    {/if}
{literal}

{/literal}
    {if isset($cadastro.campus.0.campus) && !empty($cadastro.campus.0.campus)}
{literal}
    $('#campus').select2(
        'data', {
            id: {/literal}{$cadastro.campus.0.id}{literal},
            campus: '{/literal}{$cadastro.campus.0.campus}{literal}'
        }
    );
{/literal}
    {/if}
{literal}


{/literal}
    {if isset($cadastro.trabalho_relaciona_palavra_chave) && !empty($cadastro.trabalho_relaciona_palavra_chave)}
{literal}
    var palavras_chave = {/literal}{json_encode($cadastro.trabalho_relaciona_palavra_chave)}{literal};

    $.each(palavras_chave, function(index, item){
        palavras_chave[index] = {
            'id':            item['palavra_chave'][0]['id'],
            'palavra_chave': item['palavra_chave'][0]['palavra_chave']
        }
    });

        $('#palavra_chave').select2(
            'data', palavras_chave
        );
{/literal}
    {/if}
{literal}


</script>
{/literal}





                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="module-footer text-center">
                        <div class="form-group col-xs-12 col-sm-12 col-md-12 col-lg-12">
                            <button type="submit" class="btn btn-success botao_enviar pull-right">
                                {if isset($cadastro)}Editar {$modulo.send}{else}Cadastrar Novo {$modulo.send}{/if}
                            </button>

                            {if isset($cadastro)}
                                <button type="button" onclick="window.history.back();" class="btn btn btn-danger botao_voltar pull-right marginR10">
                                    {if isset($cadastro)}Cancelar{else}Voltar{/if}
                                </button>

                                {if empty($cadastro.status)}
                                    {if !empty($permissao_aprovar_reprovar.aprovar)}
                                        <a href='/{$modulo.modulo}/aprovar_reprovar/{$cadastro.id}/1' title='Aprovar Trabaho'>
                                            <button type="button" class="btn btn-success pull-righ marginR10 lazy_view_ignore">
                                                Aprovar Trabalho
                                            </button>
                                        </a>
                                    {/if}

                                    {if !empty($permissao_aprovar_reprovar.reprovar)}
                                        <a href='/{$modulo.modulo}/aprovar_reprovar/{$cadastro.id}/2' title='Aprovar Trabaho'>
                                            <button type="button" class="btn btn-danger pull-righ marginR10 lazy_view_ignore">
                                                Reprovar Trabalho
                                            </button>
                                        </a>
                                    {/if}
                                {/if}
                            {/if}
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </section>
</div>


<div class="clearfix"></div>